
{% extends "base.html" %}

{% block title %} MarketDial FleetCommander™{% endblock %}

{% block content %}

<h2 class="mt-2 text-[36px] font-medium text-[#212121]">Enter store name to find locations:</h2>

    <!-- Search Form -->
    <form id="search-form">
        <label class="mt-2 text-[24px] font-medium text-[#212121]">Store Name:</label>
        <input id="location-name" name="name" size="32" value="Harmons" class="border-4 border-indigo mt-2 text-[24px] font-medium text-[#212121]" required/>
        <!-- <select id="store-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"></select> -->
        <select id="store-type" class="focus:outline-none text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-[16px] px-5 py-2.5 mb-2 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-900"></select>
        <button onclick="searchLocation()" type=button class="focus:outline-none text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-[16px] px-5 py-2.5 mb-2 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-900">Show Locations</button>
    </form>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize the map centered on the world
        var map = L.map('map').setView([20, 0], 2);

        // Load OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        function getRandomColor() {
          const letters = '0123456789ABCDEF';
          let color = '#';
          for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return color;
        }

                // Store types and counts
        const storeTypes = [
            { name: '(all store types)', count: 611070 },
            { name: 'supermarket', count: 415222 },
            { name: 'clothes', count: 313566 },
            // Add the rest of the store types here...
            { name: 'toys', count: 19521 }
        ];

      const storeTypeSelect = document.getElementById('store-type');
        storeTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.name; // Set value to the type name
            option.textContent = `${type.name.charAt(0).toUpperCase() + type.name.slice(1)} (${type.count})`; // Formatted label
            storeTypeSelect.appendChild(option);
        });

        function searchLocation() {
            var locationName = document.getElementById("location-name").value;
            var storeType = storeTypeSelect.value; // Get selected store type (name)

            // Check if storeType is correctly retrieved
            console.log("Selected store type:", storeType);
            var markerColor = getRandomColor();

            // Fetch coordinates from the /search endpoint
            fetch(`/search?name=${encodeURIComponent(locationName)}&type=${storeType}`)
                .then(response => response.json())
                .then(data => {
                    var coordinatesArray = data.coordinates;

                    // Check if we received an array of coordinates
                    if (Array.isArray(coordinatesArray) && coordinatesArray.length > 0) {
                        // Loop through each coordinate in the array
                        coordinatesArray.forEach(function(coordinates) {
                            if (coordinates && coordinates.lat && coordinates.lng) {
                                // Add marker to world map
                        var popupContent = `
                            <b>${coordinates.name}</b><br>
                            <i>${coordinates.type}</i><br>
                            <p>${coordinates.address}</p>
                        `;

                        // Add marker to map with the custom popup
                        L.circleMarker([coordinates.lat, coordinates.lng], {
            radius: 8, // Size of the marker
            fillColor: markerColor, // Marker fill color
            color: "#000", // Marker border color
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8 // Opacity of the fill color
        }).addTo(map)
                            .bindPopup(popupContent)
                            .openPopup();

                                // Center world map on the first location
                                map.setView([coordinatesArray[0].lat, coordinatesArray[0].lng], 4);
                            }
                        });
                    } else {
                        alert("No locations found.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    alert("An error occurred while searching for the locations: " + error);
                });
        }    </script>

{% endblock %}